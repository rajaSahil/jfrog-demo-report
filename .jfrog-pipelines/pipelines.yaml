template: true   # required for local templates
valuesFilePath: ./values.yaml

resources:
  - name: docker_image
    type: Image
    configuration:
      registry: {{ .Values.docker.dockerIntegrationName }}
      imageName: {{ .Values.docker.imageName }}
      imageTag: {{ .Values.docker.imageTag }}
      autoPull: true

pipelines:
  - name: {{ .Values.docker.pipelineName }}
    steps:
      - name: run_image
        type: Bash
        configuration:
          inputResources:
            - name: docker_image
        execution:
          onExecute:
            - docker run rajasahil/accuknox-cli:v1 install


      - name: helmDeployStep
        type: HelmDeploy
        configuration:
          helmVersion: 3
          namespace: kps
          releaseName: kps
          chartName: prometheus-community/kube-prometheus-stack
          chartVersion: 47.2.0
          dryRun: true
          integrations:
            - name: kubernetes_integration
          inputResources:
            - name: HelmChart
        execution:
          onStart:
            - echo "Preparing for work..."
          onSuccess:
            - echo "Job well done!"
          onFailure:
            - echo "uh oh, something went wrong"
          onComplete: #always
            - echo "Cleaning up some stuff"